<!DOCTYPE html>
<html>
<head>
<title>智慧工地</title>

  <link rel="stylesheet" type="text/css" href="file:///android_asset/css/weui.css">
  <link rel="stylesheet" type="text/css" href="file:///android_asset/css/smartsite.css">
  <!--Let browser know website is optimized for mobile-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <script src="file:///android_asset/jquery/jquery-1.7.2.min.js"></script>

  <style type="text/css">
  	html,body,.page{
      height: 100%;
	  width: 100%;
    }
	body{
	  width: 100%;
	  margin: 0px;
	  padding: 0px;

	}
	  main{
	    position: absolute;
	    margin-top:64px;
	    overflow: hidden;
	  }
	.weui-grid {
      width: 25%;
    }
  </style>
</head>
<body>
<main>
  <div class="page">
    <!--<div class="page__hd">-->
        <!--<h1 class="page__title">本地控制面板</h1>-->
        <!--<p class="page__desc">主要模块</p>-->
    <!--</div>-->
    <div class="weui-grids">
        <a href="" class="weui-grid" id="myintroduction">
            <div class="weui-grid__icon">
                <img src="./images/introduction.png" alt="">
            </div>
            <p class="weui-grid__label">项目简介</p>
        </a>
	    <a href="groups.html?id=0" class="weui-grid">
		    <div class="weui-grid__icon">
			    <img src="./images/workgroups.png" alt="">
		    </div>
		    <p class="weui-grid__label">施工班组</p>
	    </a>
        <a href="mylocalfiles.html?id=52" class="weui-grid">   <!--localdrawings.html-->
            <div class="weui-grid__icon">
                <img src="./images/drawing.png" alt="">
            </div>
            <p class="weui-grid__label">图纸CAD</p>
        </a>
        <!--<a href="" class="weui-grid">
            <div class="weui-grid__icon">
                <img src="./images/monitor.png" alt="">
            </div>
            <p class="weui-grid__label">现场监控</p>
        </a>-->
        <a href="mylocalfiles.html?id=53" class="weui-grid">     <!--techcontrol-->
            <div class="weui-grid__icon">
                <img src="./images/techcontrol.png" alt="">
            </div>
            <p class="weui-grid__label">技术控制</p>
        </a>
        <a href="mylocalfiles.html?id=54" class="weui-grid">     <!--securitycontrol-->
            <div class="weui-grid__icon">
                <img src="./images/securitycontrol.png" alt="">
            </div>
            <p class="weui-grid__label">安全控制</p>
        </a>
        <a href="mylocalfiles.html?id=78" class="weui-grid">       <!--materials-->
            <div class="weui-grid__icon">
                <img src="./images/materials.png" alt="">
            </div>
            <p class="weui-grid__label">计划物资</p>
        </a>

        <a href="mylocalfiles.html?id=56" class="weui-grid">     <!--projectschedule-->
            <div class="weui-grid__icon">
                <img src="./images/projectschedule.png" alt="">
            </div>
            <p class="weui-grid__label">项目进度</p>
        </a>
	    <a href="userinfo.html" class="weui-grid">
		    <div class="weui-grid__icon">
			    <img src="./images/recordsquery.png" alt="">
		    </div>
		    <p class="weui-grid__label">操作记录</p>
	    </a>
        <!--<a href="pad.html" class="weui-grid">
            <div class="weui-grid__icon">
                <img src="./images/pad.png" alt="">
            </div>
            <p class="weui-grid__label">设备管理</p>
        </a>-->
        <!--<a href="localfiles.html" class="weui-grid">
            <div class="weui-grid__icon">
                <img src="./images/download.png" alt="">
            </div>
            <p class="weui-grid__label">文件下载</p>
        </a>-->

	    <!--本地文件删除功能-->
	    <!--<a href="localfilesmanage.html" class="weui-grid">
		    <div class="weui-grid__icon">
			    <img src="./images/download.png" alt="">
		    </div>
		    <p class="weui-grid__label">资料管理</p>
	    </a>-->
	    <a href="photo.html" class="weui-grid">
		    <div class="weui-grid__icon">
			    <img src="./images/monitor.png" alt="">
		    </div>
		    <p class="weui-grid__label">图像采集</p>
	    </a>
	    <a href="localphotosmanage.html" class="weui-grid">
		    <div class="weui-grid__icon">
			    <img src="./images/download.png" alt="">
		    </div>
		    <p class="weui-grid__label">本地图片管理</p>
	    </a>
        <a href="upload.html" class="weui-grid">
            <div class="weui-grid__icon">
                <img src="./images/upload.png" alt="">
            </div>
            <p class="weui-grid__label">文件上传</p>
        </a>

	    <a href="deviceinfo.html" class="weui-grid">
		    <div class="weui-grid__icon">
			    <img src="./images/pad.png" alt="">
		    </div>
		    <p class="weui-grid__label">设备信息</p>
	    </a>
	    <!--<a href="javascript:void(0)" class="weui-grid" onclick="queryDatabase();">
		    <div class="weui-grid__icon">
			    <img src="./images/download.png" alt="">
		    </div>
		    <p class="weui-grid__label">测试数据库</p>
	    </a>-->
    </div>
  </div>
</main>

<script type="text/javascript">
	$registerurl = SystemUtils.getRegisterUrl();        //检查是否注册（用于验证网络是否连接）
    $url = SystemUtils.getServerRecordUrl();            // 获得记录上传路径 /monitor/staff/add
    $fileurl = SystemUtils.getServerFileUrl();          // 获得文件列表 /document/file/get
    //$typeurl = SystemUtils.getServerTypeUrl();        //获得文档一级分类列表
    $typelisturl = SystemUtils.getServerTypeListUrl();  //获得文档所有分类级别列表
    var fileArray = new Array();    //文件路径
    var nameArray = new Array();    //文件名

	$(function(){
		if(SystemUtils.isConnectingToInternet()==true){     //在联网状态下
			$.ajax({                // 同步记录
				url: $registerurl,
				timeout: 500,       //超时时间设置，单位毫秒
			    type: "get",
			    async: true,        //async必须设置为同步ture，timeout才生效
			    success: function (info) {
	                SystemUtils.consolelog("success: "+info.success);   //返回成功
	                $("#myintroduction").attr("href",SystemUtils.getServerIntroductionUrl());
					if(window.openDatabase){
						//SystemUtils.showToast("浏览器支持DataBase！");
						buildLocalDatabase();
					}
					synchRecords();         //同步记录（异步操作）
					downloadAllFiles();     //下载文件（同步操作）
			    },
			    error: function (XMLHttpRequest,status) {
			        SystemUtils.consolelog("你的网络连接存在异常！ status:"+status);
			        $("#myintroduction").attr("href",SystemUtils.getLocalErrorPage());
			        if(status=='timeout'){
			            SystemUtils.showToast("你的服务器响应超时！");
			        }
			        else{
			            SystemUtils.showToast("网络异常，请检查网络连接！");
			        }
			        return;
			    }
			});
		}
		else{
			$("#myintroduction").attr("href",SystemUtils.getLocalErrorPage());
			SystemUtils.showToast("网络未连接！");
		}
	});

    function synchRecords(){
        //SystemUtils.showToast("正在同步浏览记录！ ");
        var array = FileUtils.getAllFileRecords();
        var arrayObj = eval("("+array+")");
		//SystemUtils.showToast("synchRecords() arrayObj.length: "+arrayObj.length);
		if(arrayObj.length<3){  //至少保存size，"0_0"，"0_1"三项信息
			//ystemUtils.showToast("暂无可同步记录！ ");
			return;
		}
        var imei=SystemUtils.getAndroidPadCol();
        $.ajax({            // 同步记录
			url: $url,
			//timeout: 500,  //超时时间设置，单位毫秒
			data: {"log": arrayObj,"imei":imei},
		    type: "post",
		    //async: true,    //async必须设置为同步ture，timeout才生效
		    success: function (info) {
                //SystemUtils.showToast("success: "+info.info);
                FileUtils.deleteLocalRecords();
		    },
		    error: function (XMLHttpRequest,status) {
		        SystemUtils.consolelog("同步记录请求错误 status:"+status);
		        if(status=='timeout'){
		            SystemUtils.showToast("同步记录请求服务器响应超时！");
		        }
		        else{
		            SystemUtils.showToast("同步记录请求网络异常，请检查网络连接！");
		        }
		    }
		});
    }

	function downloadAllFiles() {    //自动同步文件
		$.ajax({
			url: $fileurl,
			//timeout: 1000, //超时时间设置，单位毫秒
		    type: "get",
		    async: false,   //false代表只有在等待ajax执行完毕后才执行后面语句
		    success: function (filesinfo) {
		    	var obj = eval('(' + filesinfo + ')');
				for (var i = 0; i < obj.recordsTotal ; i++ ) {
					fileArray.push(obj.data[i].savepath+obj.data[i].savename);  //保存路径名+文件名
					nameArray.push(obj.data[i].name);
				}
		    },
		    error: function (XMLHttpRequest,status) {
		        SystemUtils.consolelog("同步文件列表请求错误 status:"+status);
		        if(status=='timeout'){
		            SystemUtils.showToast("同步文件列表请求服务器响应超时！");
		        }
		        else{
		            SystemUtils.showToast("同步文件列表请求网络异常，请检查网络连接！");
		        }
		    }
		});
		var array = FileUtils.getFileList();        //字符串
        var savename;
		for(var i=0;i<fileArray.length;i++){
			savename = fileArray[i].split("/")[1];
			if(array.indexOf(savename)<0){          //未被下载
				downloadFile( SystemUtils.getDownloadURL()+fileArray[i] );      //模拟下载
				FileUtils.setFileInfo(nameArray[i],savename);
			}
		}
	}

	function downloadFile(fileName){        //模拟点击a标签进行文件下载
		SystemUtils.consolelog("文件下载："+fileName)
	    var link= $("<a href='"+fileName+"'></a>");
		link.get(0).click();
	}

	function buildLocalDatabase(){         //websql前端数据库
		var success = function(tx,results){     //成功回调
	        //SystemUtils.consolelog("results:"+results);
	    };
	    var error = function(tx, err){          //失败回调
	        //SystemUtils.consolelog("err:"+err);
	    };
		//创建数据库，（数据库名，数据库版本号，描述，估计大小）
		var smartsite_db = window.openDatabase('smartsite', '1.0', 'smartsite DB', 2 * 1024 * 1024);
		//创建一个数据表(iddoctype unique, name, fatherid, fathername, level)
		var create_doctype_sql = 'CREATE TABLE IF NOT EXISTS doctype (iddoctype INTEGER  unique, name, fatherid INTEGER , fathername, level INTEGER )';
		var create_file_sql = 'CREATE TABLE IF NOT EXISTS file (idfile INTEGER  unique, name, datetime DATETIME, savename, savepath, iddoctype INTEGER , doctypename )';
		smartsite_db.transaction(function(tx){
			tx.executeSql("DROP TABLE IF EXISTS doctype",[]);      //每次联网时更新数据库doctype和file
			tx.executeSql("DROP TABLE IF EXISTS file",[]);
		    tx.executeSql(create_doctype_sql,[]);
		    tx.executeSql(create_file_sql,[]);
		    //SystemUtils.consolelog("create local database success!");
		});
		$.ajax({
            url: $typelisturl,
            //timeout: 500, //超时时间设置，单位毫秒
            type: "get",
            //async: true,    //async必须设置为同步ture，timeout才生效
            success: function (doctypelist) {
                var obj = eval('(' + doctypelist + ')');
                if(obj.recordsTotal>0){
                    //将数据存入前端数据库
					smartsite_db.transaction(function(tx){
	                    for (var i = 0; i < obj.recordsTotal ; i++ ) {
							tx.executeSql('INSERT INTO doctype (iddoctype, name, fatherid, fathername, level ) VALUES (?,?,?,?,?)',
								[ obj.data[i].id, obj.data[i].name, obj.data[i].fatherid, obj.data[i].fathername, obj.data[i].level ], success, error);
	                    }
	                });
                }
            },
            error: function (XMLHttpRequest,status) {
                SystemUtils.consolelog("存储文件类型请求错误 status:"+status);
		        if(status=='timeout'){
		            SystemUtils.showToast("存储文件类型请求服务器响应超时！");
		        }
		        else{
		            SystemUtils.showToast("存储文件类型请求网络异常，请检查网络连接！");
		        }
		    }
        });
        //将服务器文件列表保存至本地
        $.ajax({
            url: $fileurl,
            //timeout: 500,
            type: "get",
            //async: true,    //async必须设置为同步ture，timeout才生效
            success: function (filesinfo) {
                var obj = eval('(' + filesinfo + ')');
                //将数据存入前端数据库
				smartsite_db.transaction(function(tx){
					for (var i = 0; i < obj.recordsTotal ; i++ ) {
						tx.executeSql('INSERT INTO file (idfile, name, datetime, savename, savepath, iddoctype, doctypename ) VALUES (?,?,?,?,?,?,?)',
							[ obj.data[i].id, obj.data[i].name, obj.data[i].datetime, obj.data[i].savename, obj.data[i].savepath, obj.data[i].iddoctype, obj.data[i].doctypename ], success, error);
	                }
				});
            },
            error: function (XMLHttpRequest,status) {
                SystemUtils.consolelog("存储文件列表请求错误 status:"+status);
		        if(status=='timeout'){
		            SystemUtils.showToast("存储文件列表请求服务器响应超时！");
		        }
		        else{
		            SystemUtils.showToast("存储文件列表请求网络异常，请检查网络连接！");
		        }
		    }
        });
	}

	function queryDatabase(){
		SystemUtils.consolelog("查询前端数据库");
		//打开数据库
		var smartsite_db = window.openDatabase('smartsite', '1.0', 'smartsite DB', 2 * 1024 * 1024);
		//查询数据
		smartsite_db.transaction(function(tx){
			//tx.executeSql('SELECT * FROM localdataset where name like ? ', ['%控制%'], function (tx, results) {
			tx.executeSql('SELECT * FROM localdataset where iddoctype < ? ', [60], function (tx, results) {
				SystemUtils.consolelog("results.rows.length:"+results.rows.length);
			    var len = results.rows.length, i;
			    for (i = 0; i < len; i++) {
			        SystemUtils.consolelog("iddoctype:"+results.rows.item(i).iddoctype+" &name:"+results.rows.item(i).name);
			    }
			});
		});
	}
</script>
</body>
</html>